<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√†i gi·∫£ng: T√°ch Kim Lo·∫°i v√† S·ª≠ D·ª•ng H·ª£p Kim - Th·∫ßy L√¢m</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            scroll-behavior: smooth;
            background-color: #f0f9ff; /* light-blue-50 */
        }
        .pill-button {
            transition: all 0.3s ease;
        }
        .pill-button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 12px 24px -8px rgba(20, 184, 166, 0.4);
        }
        .secondary-button {
            transition: all 0.2s ease;
        }
        .secondary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .quiz-option {
            transition: all 0.2s ease-in-out;
        }
        .quiz-option:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .quiz-option.selected {
            border-color: #fbbf24; /* amber-400 */
            background-color: #fefce8; /* yellow-50 */
            box-shadow: 0 0 0 2px #fbbf24;
        }
        .quiz-option.correct {
            background-color: #ecfdf5 !important; /* green-50 */
            border-color: #10b981 !important; /* emerald-500 */
            color: #065f46; /* emerald-800 */
        }
        .quiz-option.incorrect {
            background-color: #fff1f2 !important; /* rose-50 */
            border-color: #f43f5e !important; /* rose-500 */
            color: #9f1239; /* rose-800 */
        }
        .quiz-option.correct-answer-highlight {
             border-color: #10b981;
             box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }
        .flag-button.flagged svg {
            fill: #f59e0b; /* amber-500 */
        }
        .tab-button.active {
            border-bottom-color: #0d9488; /* teal-600 */
            color: #0d9488;
            font-weight: 700;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #14b8a6; /* teal-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for mobile nav */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-gradient-to-br from-cyan-400 to-teal-600 z-50 flex flex-col items-center justify-center p-4">
        <div id="ad-banner" class="absolute top-4 right-4 bg-white p-2 rounded-lg shadow-lg max-w-xs z-10">
            <button onclick="document.getElementById('ad-banner').style.display='none'" class="absolute -top-2 -right-2 bg-gray-700 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">&times;</button>
            <img src="https://i.imgur.com/RGTC0CZ.png" alt="Qu·∫£ng c√°o kh√≥a h·ªçc VIP" class="rounded-md w-full">
        </div>
        <div class="text-center text-white">
            <h1 class="text-4xl md:text-6xl font-extrabold mb-2 drop-shadow-lg">T√ÅCH KIM LO·∫†I & S·ª¨ D·ª§NG H·ª¢P KIM</h1>
            <p class="text-xl md:text-2xl mb-8 drop-shadow">B√†i gi·∫£ng H√≥a h·ªçc l·ªõp 9 c√πng <span class="font-bold text-amber-300">Th·∫ßy L√¢m</span></p>
            <button id="start-learning-btn" class="pill-button bg-gradient-to-r from-amber-400 to-yellow-500 text-teal-900 font-bold py-3 px-10 rounded-full text-lg shadow-xl">
                B·∫Øt ƒë·∫ßu h·ªçc
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <header class="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex flex-col items-center">
                <div class="text-3xl font-extrabold text-teal-700">
                    H√≥a H·ªçc 9
                </div>
                <nav id="tabs" class="w-full mt-3">
                    <div class="w-full overflow-x-auto whitespace-nowrap scrollbar-hide text-center">
                        <button class="tab-button text-slate-600 py-2 px-4 inline-block border-b-4 border-transparent active" onclick="showTab('intro')">Gi·ªõi thi·ªáu</button>
                        <button class="tab-button text-slate-600 py-2 px-4 inline-block border-b-4 border-transparent" onclick="showTab('content1')">T√°ch Kim Lo·∫°i</button>
                        <button class="tab-button text-slate-600 py-2 px-4 inline-block border-b-4 border-transparent" onclick="showTab('content2')">H·ª£p Kim</button>
                        <button class="tab-button text-slate-600 py-2 px-4 inline-block border-b-4 border-transparent" onclick="showTab('quiz')">Ki·ªÉm tra</button>
                    </div>
                </nav>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-8">
            <!-- Tab Content -->
            <div id="intro" class="tab-content">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500">
                    <h2 class="text-3xl font-bold text-teal-600 mb-4 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><path d="M12 6.52c.8-.83 2.18.25 1.4 1.45l-4.1 4.1c-.22.22-.22.58 0 .8l4.1 4.1c.78 1.2-1.4 1.4-1.4 1.45-1.6.1-2.9-1.2-2.9-2.85 0-.8.3-1.5.8-2.1l-2.3-2.3c-.3-.3-.3-.8 0-1.1l2.3-2.3c-.5-.6-.8-1.3-.8-2.1 0-1.65 1.3-2.95 2.9-2.85z"/><path d="M18 6.52c.8-.83 2.18.25 1.4 1.45l-4.1 4.1c-.22.22-.22.58 0 .8l4.1 4.1c.78 1.2-1.4 1.4-1.4 1.45-1.6.1-2.9-1.2-2.9-2.85 0-.8.3-1.5.8-2.1l-2.3-2.3c-.3-.3-.3-.8 0-1.1l2.3-2.3c-.5-.6-.8-1.3-.8-2.1 0-1.65 1.3-2.95 2.9-2.85z"/></svg>
                        L·ªùi ch√†o t·ª´ Th·∫ßy L√¢m!
                    </h2>
                    <p class="text-lg mb-4 text-slate-700">
                        Ch√†o c√°c em h·ªçc sinh th√¢n m·∫øn! H√¥m nay, th·∫ßy tr√≤ ch√∫ng ta s·∫Ω c√πng nhau kh√°m ph√° m·ªôt ch·ªß ƒë·ªÅ v√¥ c√πng th√∫ v·ªã: l√†m th·∫ø n√†o ƒë·ªÉ "gi·∫£i c·ª©u" c√°c kim lo·∫°i kh·ªèi nh·ªØng h·ª£p ch·∫•t giam gi·ªØ ch√∫ng v√† c√°ch con ng∆∞·ªùi "k·∫øt b·∫°n" c√°c kim lo·∫°i l·∫°i v·ªõi nhau ƒë·ªÉ t·∫°o ra nh·ªØng v·∫≠t li·ªáu m·ªõi si√™u vi·ªát g·ªçi l√† h·ª£p kim.
                    </p>
                    <p class="text-lg mb-4 text-slate-700">
                        H√£y t∆∞·ªüng t∆∞·ª£ng kim lo·∫°i nh∆∞ nh·ªØng v·ªã vua b·ªã giam c·∫ßm trong c√°c "l√¢u ƒë√†i" qu·∫∑ng m·ªè. Nhi·ªám v·ª• c·ªßa ch√∫ng ta l√† t√¨m ra ch√¨a kh√≥a ƒë·ªÉ m·ªü nh·ªØng l√¢u ƒë√†i ƒë√≥. V√† h·ª£p kim? ƒê√≥ l·∫°i l√† c√¢u chuy·ªán v·ªÅ s·ª± ƒëo√†n k·∫øt. Gi·ªëng nh∆∞ trong truy·ªán ng·ª• ng√¥n "B√≥ ƒë≈©a", khi c√°c kim lo·∫°i ƒë·ª©ng ri√™ng l·∫ª, ch√∫ng c√≥ th·ªÉ y·∫øu ·ªõt, nh∆∞ng khi k·∫øt h·ª£p l·∫°i, ch√∫ng t·∫°o n√™n m·ªôt s·ª©c m·∫°nh phi th∆∞·ªùng.
                    </p>
                    <p class="text-lg font-semibold text-teal-700">
                        N√†o, h√£y c√πng th·∫ßy b·∫Øt ƒë·∫ßu h√†nh tr√¨nh kh√°m ph√° nh·ªØng b√≠ m·∫≠t c·ªßa th·∫ø gi·ªõi kim lo·∫°i nh√©!
                    </p>
                </div>
            </div>

            <div id="content1" class="tab-content hidden">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500">
                    <div id="theory-section-1">
                        <h2 class="text-3xl font-bold text-teal-600 mb-6">PH∆Ø∆†NG PH√ÅP V√Ä QU√Å TR√åNH T√ÅCH KIM LO·∫†I</h2>
                        <p class="mb-6 bg-sky-50 border-l-4 border-sky-400 p-4 rounded-r-lg text-slate-700">Nguy√™n t·∫Øc chung ƒë·ªÉ ƒëi·ªÅu ch·∫ø kim lo·∫°i l√† kh·ª≠ ion kim lo·∫°i th√†nh nguy√™n t·ª≠ kim lo·∫°i: \(\ M^{n+} + ne \rightarrow M \).</p>
                        
                        <div class="space-y-8">
                            <div>
                                <h3 class="text-xl font-bold text-sky-700">1. Ph∆∞∆°ng ph√°p th·ªßy luy·ªán (d√πng cho kim lo·∫°i y·∫øu)</h3>
                                <p class="mt-2 text-slate-600">D√πng kim lo·∫°i c√≥ t√≠nh kh·ª≠ m·∫°nh h∆°n ƒë·ªÉ kh·ª≠ ion c·ªßa kim lo·∫°i y·∫øu h∆°n trong dung d·ªãch mu·ªëi.</p>
                                <p class="mt-2 p-3 bg-slate-50 rounded-lg text-center font-mono">\( Fe + CuSO_4 \rightarrow FeSO_4 + Cu \downarrow \)</p>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-sky-700">2. Ph∆∞∆°ng ph√°p nhi·ªát luy·ªán (d√πng cho kim lo·∫°i trung b√¨nh, y·∫øu)</h3>
                                <p class="mt-2 text-slate-600">D√πng c√°c ch·∫•t kh·ª≠ m·∫°nh nh∆∞ C, CO, H<sub>2</sub>, Al ƒë·ªÉ kh·ª≠ oxit kim lo·∫°i ·ªü nhi·ªát ƒë·ªô cao.</p>
                                <p class="mt-2 p-3 bg-slate-50 rounded-lg text-center font-mono">\( Fe_2O_3 + 3CO \xrightarrow{t^\circ} 2Fe + 3CO_2 \uparrow \)</p>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-sky-700">3. Ph∆∞∆°ng ph√°p ƒëi·ªán ph√¢n (d√πng cho kim lo·∫°i m·∫°nh)</h3>
                                <p class="mt-2 text-slate-600">D√πng d√≤ng ƒëi·ªán m·ªôt chi·ªÅu ƒë·ªÉ kh·ª≠ ion kim lo·∫°i. Th∆∞·ªùng l√† ƒëi·ªán ph√¢n n√≥ng ch·∫£y c√°c h·ª£p ch·∫•t c·ªßa ch√∫ng.</p>
                                <p class="mt-2 p-3 bg-slate-50 rounded-lg text-center font-mono">\( 2NaCl \xrightarrow{\text{ƒëpnc}} 2Na + Cl_2 \uparrow \)</p>
                            </div>
                        </div>
                        
                        <div class="mt-10 border-t-2 border-dashed pt-8">
                            <h3 class="text-2xl font-bold text-center text-teal-700 mb-4">V√≠ d·ª• ƒëi·ªÉn h√¨nh: S·∫£n xu·∫•t Nh√¥m</h3>
                            <p class="mt-2 text-center text-slate-600">Nh√¥m l√† kim lo·∫°i r·∫•t ho·∫°t ƒë·ªông, v√¨ v·∫≠y n√≥ ƒë∆∞·ª£c s·∫£n xu·∫•t b·∫±ng c√°ch ƒëi·ªán ph√¢n n√≥ng ch·∫£y nh√¥m oxit ($Al_2O_3$) c√≥ l·∫´n criolit (l√†m gi·∫£m nhi·ªát ƒë·ªô n√≥ng ch·∫£y v√† tƒÉng ƒë·ªô d·∫´n ƒëi·ªán).</p>
                            <p class="mt-2 text-center p-3 bg-slate-50 rounded-lg font-mono">\( 2Al_2O_3 \xrightarrow[\text{criolit}]{\text{ƒëpnc}} 4Al + 3O_2 \uparrow \)</p>
                            <p class="mt-6 font-semibold text-center text-slate-700">Xem video m√¥ ph·ªèng quy tr√¨nh s·∫£n xu·∫•t nh√¥m t·ª´ qu·∫∑ng bauxite:</p>
                            <div class="relative mt-4 rounded-lg overflow-hidden shadow-lg mx-auto max-w-2xl" style="padding-bottom: 56.25%;">
                                <iframe class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/mMfnDwRbPw0" title="Quy tr√¨nh s·∫£n xu·∫•t nh√¥m" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                            </div>
                        </div>

                        <div class="mt-10 border-t-2 border-dashed pt-8">
                            <h3 class="text-2xl font-bold text-center text-teal-700 mb-4">V√≠ d·ª• kh√°c: S·∫£n xu·∫•t ƒê·ªìng</h3>
                            <p class="mt-2 text-center text-slate-600">ƒê·ªìng l√† kim lo·∫°i ho·∫°t ƒë·ªông trung b√¨nh, c√≥ th·ªÉ ƒë∆∞·ª£c ƒëi·ªÅu ch·∫ø b·∫±ng nhi·ªÅu ph∆∞∆°ng ph√°p nh∆∞ nhi·ªát luy·ªán ho·∫∑c th·ªßy luy·ªán. Video d∆∞·ªõi ƒë√¢y minh h·ªça m·ªôt quy tr√¨nh s·∫£n xu·∫•t ƒë·ªìng hi·ªán ƒë·∫°i.</p>
                            <p class="mt-6 font-semibold text-center text-slate-700">Xem video quy tr√¨nh s·∫£n xu·∫•t ƒë·ªìng:</p>
                            <div class="relative mt-4 rounded-lg overflow-hidden shadow-lg mx-auto max-w-2xl" style="padding-bottom: 56.25%;">
                                <iframe class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/SbECvSHR4rQ" title="Quy tr√¨nh s·∫£n xu·∫•t ƒë·ªìng" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                            </div>
                        </div>

                        <div class="mt-10 border-t-2 border-dashed pt-8">
                            <h3 class="text-2xl font-bold text-center text-teal-700 mb-4">M√¥ ph·ªèng: ƒêi·ªán ph√¢n n√≥ng ch·∫£y NaCl</h3>
                            <div class="bg-slate-200/50 p-4 rounded-lg flex justify-center items-center h-64">
                                <svg id="electrolysis-svg" width="300" height="200" viewBox="0 0 300 200">
                                    <rect x="50" y="50" width="200" height="120" fill="#e0f2fe" stroke="#0ea5e9" stroke-width="2"/>
                                    <text x="150" y="40" text-anchor="middle" font-size="14">Dung d·ªãch NaCl n√≥ng ch·∫£y</text>
                                    <rect x="80" y="70" width="20" height="80" fill="#71717a"/>
                                    <text x="90" y="65" text-anchor="middle" font-weight="bold">- Catot</text>
                                    <rect x="200" y="70" width="20" height="80" fill="#71717a"/>
                                    <text x="210" y="65" text-anchor="middle" font-weight="bold">Anot +</text>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-10 border-t-2 border-dashed pt-8">
                        <h3 class="text-2xl font-bold text-teal-700 mb-4">G√≥c t∆∞∆°ng t√°c v·ªõi AI</h3>
                        <p class="mb-3 text-slate-600">C√≥ c√¢u h·ªèi n√†o v·ªÅ vi·ªác t√°ch kim lo·∫°i kh√¥ng? H√£y h·ªèi Th·∫ßy L√¢m AI nh√©!</p>
                        <textarea id="ai-question-1" class="w-full p-3 border-2 border-slate-300 rounded-md focus:border-teal-500 focus:ring-teal-500" rows="3" placeholder="V√≠ d·ª•: T·∫°i sao ph·∫£i ƒëi·ªán ph√¢n n√≥ng ch·∫£y Al2O3 m√† kh√¥ng ph·∫£i dung d·ªãch?"></textarea>
                        <button class="secondary-button mt-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-2 px-6 rounded-lg font-semibold" onclick="askAI('ai-question-1', 'ai-answer-1')">G·ª≠i c√¢u h·ªèi</button>
                        <div id="ai-answer-1" class="mt-4 p-4 bg-amber-50 rounded-lg border-l-4 border-amber-400 hidden"></div>
                    </div>
                </div>
            </div>

            <div id="content2" class="tab-content hidden">
                 <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-amber-500">
                    <div id="theory-section-2">
                        <h2 class="text-3xl font-bold text-amber-600 mb-6">H·ª¢P KIM L√Ä G√å?</h2>
                        <p class="mb-6 bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg text-slate-700">H·ª£p kim l√† v·∫≠t li·ªáu kim lo·∫°i ch·ª©a m·ªôt kim lo·∫°i c∆° b·∫£n v√† m·ªôt s·ªë kim lo·∫°i ho·∫∑c phi kim kh√°c.</p>
                        
                        <div class="space-y-8">
                            <div>
                                <h3 class="text-xl font-bold text-amber-700">1. T√≠nh ch·∫•t c·ªßa h·ª£p kim</h3>
                                <p class="mt-2 text-slate-600">H·ª£p kim th∆∞·ªùng c√≥ nh·ªØng t√≠nh ch·∫•t h√≥a h·ªçc t∆∞∆°ng t·ª± kim lo·∫°i trong ƒë√≥, nh∆∞ng t√≠nh ch·∫•t v·∫≠t l√≠ v√† c∆° h·ªçc l·∫°i r·∫•t kh√°c. Th∆∞·ªùng th√¨ h·ª£p kim c·ª©ng v√† gi√≤n h∆°n kim lo·∫°i th√†nh ph·∫ßn, c√≥ nhi·ªát ƒë·ªô n√≥ng ch·∫£y th·∫•p h∆°n v√† d·∫´n ƒëi·ªán/nhi·ªát k√©m h∆°n.</p>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-amber-700">2. M·ªôt s·ªë h·ª£p kim quan tr·ªçng</h3>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-slate-600">
                                    <li><strong>Gang - Th√©p:</strong> H·ª£p kim c·ªßa S·∫Øt (Fe) v·ªõi Cacbon (C). Th√©p c·ª©ng h∆°n s·∫Øt, l√† v·∫≠t li·ªáu kh√¥ng th·ªÉ thi·∫øu trong x√¢y d·ª±ng, ch·∫ø t·∫°o m√°y.</li>
                                    <li><strong>Duralumin:</strong> H·ª£p kim c·ªßa Nh√¥m (Al) v·ªõi ƒê·ªìng (Cu), Mangan (Mn), Magie (Mg). Nh·∫π v√† b·ªÅn, d√πng trong c√¥ng nghi·ªáp h√†ng kh√¥ng.</li>
                                    <li><strong>V√†ng t√¢y:</strong> H·ª£p kim c·ªßa V√†ng (Au) v·ªõi ƒê·ªìng (Cu), B·∫°c (Ag)... C·ª©ng h∆°n v√†ng nguy√™n ch·∫•t, d·ªÖ gia c√¥ng, d√πng l√†m ƒë·ªì trang s·ª©c.</li>
                                    <li><strong>ƒê·ªìng thau (Brass):</strong> H·ª£p kim c·ªßa ƒê·ªìng (Cu) v√† K·∫Ωm (Zn). C√≥ m√†u v√†ng √≥ng, ch·ªëng ƒÉn m√≤n t·ªët, d√πng l√†m ƒë·ªì trang tr√≠, nh·∫°c c·ª•.</li>
                                    <li><strong>Th√©p kh√¥ng g·ªâ (Inox):</strong> H·ª£p kim c·ªßa S·∫Øt (Fe) v·ªõi Crom (Cr) v√† Niken (Ni). Ch·ªëng ƒÉn m√≤n v√† g·ªâ s√©t v∆∞·ª£t tr·ªôi, d√πng l√†m d·ª•ng c·ª• nh√† b·∫øp, y t·∫ø.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="mt-10 border-t-2 border-dashed pt-8">
                            <h3 class="text-2xl font-bold text-center text-teal-700 mb-4">Video Minh H·ªça: H·ª£p Kim</h3>
                            <p class="mt-6 font-semibold text-center text-slate-700">Xem video ƒë·ªÉ hi·ªÉu r√µ h∆°n v·ªÅ h·ª£p kim v√† c√°c ·ª©ng d·ª•ng c·ªßa ch√∫ng:</p>
                            <div class="relative mt-4 rounded-lg overflow-hidden shadow-lg mx-auto max-w-2xl" style="padding-bottom: 56.25%;">
                                <iframe class="absolute top-0 left-0 w-full h-full" src="https://www.youtube.com/embed/SttIJKywzBU" title="H·ª£p kim l√† g√¨?" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                            </div>
                        </div>

                        <div class="mt-10 border-t-2 border-dashed pt-8 bg-teal-50/50 p-6 rounded-lg">
                            <h3 class="text-2xl font-bold text-center text-teal-800 mb-4">üí° C√≥ th·ªÉ em ch∆∞a bi·∫øt?</h3>
                            <div class="space-y-4 text-slate-700">
                                <p><strong class="text-teal-700">H·ª£p kim nh·ªõ h√¨nh:</strong> C√≥ m·ªôt lo·∫°i h·ª£p kim t√™n l√† Nitinol (Niken-Titan), n√≥ c√≥ kh·∫£ nƒÉng "ghi nh·ªõ" h√¨nh d·∫°ng ban ƒë·∫ßu. D√π b·∫°n c√≥ b·∫ª cong hay l√†m bi·∫øn d·∫°ng n√≥, ch·ªâ c·∫ßn h∆° n√≥ng m·ªôt ch√∫t, n√≥ s·∫Ω t·ª± ƒë·ªông quay tr·ªü l·∫°i h√¨nh d·∫°ng g·ªëc. C√¥ng ngh·ªá n√†y ƒë∆∞·ª£c ·ª©ng d·ª•ng trong y h·ªçc ƒë·ªÉ l√†m g·ªçng k√≠nh t·ª± ƒëi·ªÅu ch·ªânh hay c√°c stent nong m·∫°ch m√°u.</p>
                                <p><strong class="text-teal-700">Si√™u h·ª£p kim:</strong> ƒê·ªông c∆° ph·∫£n l·ª±c c·ªßa m√°y bay ph·∫£i ho·∫°t ƒë·ªông ·ªü nhi·ªát ƒë·ªô v√† √°p su·∫•t c·ª±c l·ªõn. C√°c kim lo·∫°i th√¥ng th∆∞·ªùng s·∫Ω b·ªã n√≥ng ch·∫£y. Ng∆∞·ªùi ta ƒë√£ t·∫°o ra c√°c "si√™u h·ª£p kim" (superalloys) tr√™n c∆° s·ªü Niken, Coban, S·∫Øt... c√≥ th·ªÉ ch·ªãu ƒë∆∞·ª£c nh·ªØng ƒëi·ªÅu ki·ªán kh·∫Øc nghi·ªát ƒë√≥, gi√∫p m√°y bay bay cao v√† bay xa h∆°n.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-10 border-t-2 border-dashed pt-8">
                        <h3 class="text-2xl font-bold text-teal-700 mb-4">G√≥c t∆∞∆°ng t√°c v·ªõi AI</h3>
                        <p class="mb-3 text-slate-600">B·∫°n c√≥ th·∫Øc m·∫Øc g√¨ v·ªÅ h·ª£p kim kh√¥ng? ƒê·ª´ng ng·∫ßn ng·∫°i h·ªèi nh√©!</p>
                        <textarea id="ai-question-2" class="w-full p-3 border-2 border-slate-300 rounded-md focus:border-teal-500 focus:ring-teal-500" rows="3" placeholder="V√≠ d·ª•: T·∫°i sao th√™m Crom v√†o th√©p l·∫°i ch·ªëng g·ªâ?"></textarea>
                        <button class="secondary-button mt-3 bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-2 px-6 rounded-lg font-semibold" onclick="askAI('ai-question-2', 'ai-answer-2')">G·ª≠i c√¢u h·ªèi</button>
                        <div id="ai-answer-2" class="mt-4 p-4 bg-amber-50 rounded-lg border-l-4 border-amber-400 hidden"></div>
                    </div>
                </div>
            </div>

            <div id="quiz" class="tab-content hidden">
                <div id="quiz-entry" class="text-center bg-white p-8 rounded-xl shadow-xl border-t-4 border-cyan-500">
                    <h2 class="text-3xl font-bold text-cyan-600 mb-4">B√†i Ki·ªÉm Tra Cu·ªëi B√†i</h2>
                    <p class="mb-6 text-slate-600">H√£y nh·∫≠p t√™n c·ªßa em ƒë·ªÉ b·∫Øt ƒë·∫ßu l√†m b√†i nh√©!</p>
                    <input type="text" id="student-name" placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n" class="text-center w-full max-w-sm p-3 border-2 border-slate-300 rounded-lg focus:border-cyan-500 focus:ring-cyan-500">
                    <div id="student-history-msg" class="text-center my-4 text-sky-600 font-medium"></div>
                    <button id="start-quiz-btn" class="pill-button mt-4 bg-gradient-to-r from-cyan-500 to-sky-600 text-white font-bold py-3 px-10 rounded-full text-lg shadow-lg">B·∫Øt ƒë·∫ßu!</button>
                </div>

                <div id="quiz-container" class="hidden bg-white p-4 md:p-8 rounded-xl shadow-xl border-t-4 border-cyan-500">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-cyan-700">C√¢u h·ªèi <span id="question-number"></span>/<span id="total-questions"></span></h3>
                        <div class="flex items-center gap-4">
                            <button id="flag-btn" onclick="toggleFlag()" class="flag-button p-2 rounded-full hover:bg-slate-200" aria-label="ƒê√°nh d·∫•u c√¢u h·ªèi">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="question-text" class="text-lg font-semibold mb-6 min-h-[5rem] text-slate-800"></div>
                    <div id="options-container" class="space-y-3"></div>
                    <div id="review-info" class="hidden mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400">
                        <p id="review-info-text" class="text-yellow-800"></p>
                    </div>
                    <div class="mt-8 flex justify-between items-center">
                        <button id="prev-btn" class="secondary-button bg-slate-200 py-2 px-6 rounded-lg font-semibold text-slate-700">C√¢u tr∆∞·ªõc</button>
                        <div id="quiz-nav-center" class="flex gap-2">
                             <button id="next-btn" class="secondary-button bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-2 px-6 rounded-lg font-semibold">C√¢u ti·∫øp</button>
                             <button id="submit-btn" class="hidden secondary-button bg-gradient-to-r from-amber-500 to-yellow-500 text-white py-2 px-6 rounded-lg font-bold">N·ªôp b√†i</button>
                             <button id="back-to-results-btn" class="hidden secondary-button bg-sky-600 text-white py-2 px-6 rounded-lg font-bold">Quay l·∫°i k·∫øt qu·∫£</button>
                        </div>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-bold text-center mb-3 text-slate-600">Ti·∫øn ƒë·ªô</h4>
                        <div id="progress-bar" class="flex flex-wrap gap-2 justify-center"></div>
                    </div>
                </div>

                <div id="results-container" class="hidden text-center bg-white p-8 rounded-xl shadow-xl border-t-4 border-teal-500 relative overflow-hidden">
                    <div id="confetti-container" class="absolute inset-0 pointer-events-none"></div>
                    <h2 class="text-3xl font-bold text-teal-600 mb-2">Ho√†n th√†nh!</h2>
                    <p class="text-lg mb-4 text-slate-600">C√πng xem k·∫øt qu·∫£ c·ªßa <span id="result-student-name" class="font-bold"></span> nh√©!</p>
                    <div class="flex justify-around items-center my-6">
                        <div>
                            <p class="text-5xl font-extrabold text-teal-500" id="correct-count"></p>
                            <p class="text-slate-600 mt-1">S·ªë c√¢u ƒë√∫ng</p>
                        </div>
                        <div>
                            <p class="text-5xl font-extrabold text-sky-600" id="percentage"></p>
                            <p class="text-slate-600 mt-1">T·ª∑ l·ªá ch√≠nh x√°c</p>
                        </div>
                    </div>
                    <div class="text-left bg-amber-50 p-6 rounded-lg border-l-4 border-amber-400 my-6">
                        <h3 class="font-bold text-amber-800 text-lg mb-2">Nh·∫≠n x√©t t·ª´ Th·∫ßy L√¢m AI:</h3>
                        <p id="ai-analysis" class="text-amber-900/80 whitespace-pre-wrap"></p>
                    </div>
                    <p id="feedback-comment" class="text-lg font-medium text-teal-700 mb-6"></p>
                    <div class="flex flex-wrap gap-4 justify-center">
                        <button id="review-quiz-btn" class="secondary-button bg-sky-600 text-white py-2 px-6 rounded-lg font-semibold">Xem l·∫°i b√†i l√†m</button>
                        <button id="download-summary-btn" class="secondary-button bg-teal-600 text-white py-2 px-6 rounded-lg font-semibold">T·∫£i xu·ªëng T√≥m t·∫Øt</button>
                        <button onclick="location.reload()" class="secondary-button bg-slate-500 text-white py-2 px-6 rounded-lg font-semibold">L√†m l·∫°i</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <div id="modal-content">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIGURATION ---
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwlXTNBeYvXRFTETFJI65gFUywVY69dLpoL5O0H9aD0nRe3Jf5d8jWQqCQO_fZHpztU/exec';

        // --- GLOBAL STATE ---
        let currentTab = 'intro';
        let quizData = [];
        let studentAnswers = [];
        let questionTimers = [];
        let currentQuestionIndex = 0;
        let studentName = '';
        const quizTopic = 'T√ÅCH KIM LO·∫†I V√Ä S·ª¨ D·ª§NG H·ª¢P KIM';
        
        let activeTimer = null;
        let isReviewMode = false;
        let quizResultsData = null;
        let debounceTimer; // Timer for debouncing name input

        // --- DOM ELEMENTS ---
        const splashScreen = document.getElementById('splash-screen');
        const mainContent = document.getElementById('main-content');
        const startLearningBtn = document.getElementById('start-learning-btn');
        const studentNameInput = document.getElementById('student-name');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const studentHistoryMsg = document.getElementById('student-history-msg');

        // --- EVENT LISTENERS ---
        startLearningBtn.addEventListener('click', () => {
            splashScreen.classList.add('hidden');
            mainContent.classList.remove('hidden');
            runElectrolysisAnimation();
        });
        
        // **FIXED**: Remove the input event listener to prevent automatic checks
        // studentNameInput.addEventListener('input', ...); // This block is removed.

        // **UPDATED**: The logic is now inside the start button's click handler
        startQuizBtn.addEventListener('click', async () => {
            studentName = studentNameInput.value.trim();
            if (studentName === '') {
                showModalMessage('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!', 'error');
                return;
            }
            
            // Step 1: Call getStudentData and wait for it to finish. It will show its own loading modal.
            await getStudentData(studentName); 

            // Step 2: After data is fetched, get the number of questions from the button's dataset.
            const numQuestions = parseInt(startQuizBtn.dataset.questions); 

            // Step 3: Show a confirmation modal to the user.
            const message = studentHistoryMsg.innerHTML;
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">S·∫µn s√†ng l√†m b√†i?</h3>
                <div class="mb-6 text-slate-600">${message}</div>
                <div class="flex justify-center gap-4">
                    <button id="modal-cancel-btn" class="secondary-button bg-slate-300 py-2 px-6 rounded-lg">ƒê·ªÉ sau</button>
                    <button id="modal-start-btn" class="secondary-button bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-2 px-6 rounded-lg">B·∫Øt ƒë·∫ßu ngay!</button>
                </div>
            `;
            
            showModalMessage(modalContent, 'confirm', false);

            // Step 4: Add event listeners to the new modal buttons
            document.getElementById('modal-cancel-btn').onclick = closeModal;
            document.getElementById('modal-start-btn').onclick = () => {
                initiateQuiz(numQuestions);
            };
        });

        // --- TAB & NAVIGATION ---
        function showTab(tabId) {
            if (currentTab === tabId) return;
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
            
            currentTab = tabId;
            if (tabId === 'content1') runElectrolysisAnimation();
        }

        // --- API & DATA HANDLING ---
        async function fetchFromGAS(action, payload) {
            showModalMessage('<div class="loader mx-auto"></div><p class="mt-2">ƒêang x·ª≠ l√Ω...</p>', 'loading', false);
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok) throw new Error(`L·ªói m√°y ch·ªß: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message || 'C√≥ l·ªói x·∫£y ra t·ª´ ph√≠a m√°y ch·ªß.');
                closeModal();
                return result;
            } catch (error) {
                console.error('Fetch error:', error);
                showModalMessage(`L·ªói: ${error.message}. Vui l√≤ng ki·ªÉm tra l·∫°i URL c·ªßa Google Apps Script v√† th·ª≠ l·∫°i.`, 'error');
                return null;
            }
        }
        
        async function fetchFromGASSilent(action, payload) {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok) throw new Error(`L·ªói m√°y ch·ªß: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'error') throw new Error(result.message || 'C√≥ l·ªói x·∫£y ra t·ª´ ph√≠a m√°y ch·ªß.');
                return result;
            } catch (error) {
                console.error('Silent Fetch error:', error);
                return null;
            }
        }

        async function getStudentData(name) {
            const data = await fetchFromGAS('getStudentData', { name });
            if (data) {
                let numQuestions;
                let message;
                if (data.lastScore === null) {
                    numQuestions = 15;
                    message = `Ch√†o ${name}! Ch√∫c b·∫°n l√†m b√†i t·ªët v·ªõi <strong>${numQuestions}</strong> c√¢u h·ªèi ƒë·∫ßu ti√™n.`;
                } else if (data.lastScore < 50) {
                    numQuestions = 15;
                    message = `Ch√†o ${name}! L·∫ßn tr∆∞·ªõc b·∫°n l√†m ch∆∞a t·ªët l·∫Øm. B√†i n√†y s·∫Ω c√≥ <strong>${numQuestions}</strong> c√¢u ƒë·ªÉ b·∫°n c·ªßng c·ªë ki·∫øn th·ª©c nh√©.`;
                } else if (data.lastScore < 80) {
                    numQuestions = 12;
                    message = `Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i. B√†i l√†m n√†y s·∫Ω c√≥ <strong>${numQuestions}</strong> c√¢u h·ªèi.`;
                } else {
                    numQuestions = 10;
                    message = `B·∫°n l√†m r·∫•t t·ªët l·∫ßn tr∆∞·ªõc. B√†i n√†y s·∫Ω c√≥ <strong>${numQuestions}</strong> c√¢u h·ªèi ƒë·ªÉ duy tr√¨ phong ƒë·ªô.`;
                }
                studentHistoryMsg.innerHTML = message;
                startQuizBtn.dataset.questions = numQuestions;
            }
        }

        async function initiateQuiz(numQuestions) {
            closeModal(); // **FIXED**: Close confirmation modal before starting
            const data = await fetchFromGAS('getQuestions', { count: numQuestions });
            if (data && data.questions) {
                quizData = data.questions;
                studentAnswers = new Array(quizData.length).fill(null);
                questionTimers = new Array(quizData.length).fill(0);
                document.getElementById('quiz-entry').classList.add('hidden');
                document.getElementById('quiz-container').classList.remove('hidden');
                currentQuestionIndex = 0;
                isReviewMode = false;
                renderQuestion();
                renderProgressBar();
            }
        }
        
        async function askAI(questionId, answerId) {
            const questionInput = document.getElementById(questionId);
            const answerDiv = document.getElementById(answerId);
            const question = questionInput.value.trim();
            if (!question) return;
            answerDiv.innerHTML = '<div class="loader mx-auto"></div>';
            answerDiv.classList.remove('hidden');
            const result = await fetchFromGAS('askAI', { question });
            if (result && result.answer) {
                answerDiv.innerHTML = result.answer.replace(/\n/g, '<br>');
            } else {
                answerDiv.innerHTML = 'R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.';
            }
        }

        // --- QUIZ LOGIC ---
        function renderQuestion() {
            if (activeTimer) clearInterval(activeTimer);
            if (!isReviewMode) {
                const timeAlreadySpent = questionTimers[currentQuestionIndex] || 0;
                const questionStartTime = Date.now();
                activeTimer = setInterval(() => {
                    const timeSinceStart = Math.floor((Date.now() - questionStartTime) / 1000);
                    questionTimers[currentQuestionIndex] = timeAlreadySpent + timeSinceStart;
                }, 1000);
            }
            const q = quizData[currentQuestionIndex];
            document.getElementById('question-number').textContent = currentQuestionIndex + 1;
            document.getElementById('total-questions').textContent = quizData.length;
            document.getElementById('question-text').innerHTML = q.question;
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            document.getElementById('review-info').classList.add('hidden');
            const studentAns = studentAnswers[currentQuestionIndex]?.answer ?? null;
            let correctAns;
            if (isReviewMode) {
                const correctAnsObj = quizResultsData.correctAnswers.find(ans => ans.id === q.id);
                correctAns = correctAnsObj ? correctAnsObj.answer : null;
            }
            switch (q.type) {
                case 'mc':
                case 'tf':
                    const options = q.type === 'tf' ? ['ƒê√∫ng', 'Sai'] : q.options;
                    options.forEach((option, index) => {
                        const answerValue = q.type === 'tf' ? (index === 0) : index;
                        const optionEl = document.createElement('button');
                        optionEl.className = 'quiz-option w-full text-left p-4 border-2 rounded-lg';
                        optionEl.innerHTML = option;
                        optionEl.disabled = isReviewMode;
                        optionEl.onclick = () => selectAnswer(answerValue);
                        if (isReviewMode) {
                            if (answerValue === studentAns) {
                                optionEl.classList.add(answerValue === correctAns ? 'correct' : 'incorrect');
                            } else if (answerValue === correctAns) {
                                optionEl.classList.add('correct-answer-highlight');
                            }
                        } else if (studentAns === answerValue) {
                            optionEl.classList.add('selected');
                        }
                        optionsContainer.appendChild(optionEl);
                    });
                    break;
                case 'fib':
                    const inputEl = document.createElement('input');
                    inputEl.type = 'text';
                    inputEl.className = 'w-full p-3 border-2 border-slate-300 rounded-lg focus:border-cyan-500 focus:ring-cyan-500';
                    inputEl.placeholder = 'Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...';
                    inputEl.disabled = isReviewMode;
                    inputEl.oninput = () => selectAnswer(inputEl.value);
                    if (studentAns) inputEl.value = studentAns;
                    optionsContainer.appendChild(inputEl);
                    if (isReviewMode) {
                        const isCorrect = correctAns.includes((studentAns || '').toString().trim().toLowerCase());
                        inputEl.classList.add(isCorrect ? 'correct' : 'incorrect');
                        const reviewInfo = document.getElementById('review-info');
                        const reviewText = document.getElementById('review-info-text');
                        reviewText.innerHTML = `<strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctAns.join(' ho·∫∑c ')}`;
                        reviewInfo.classList.remove('hidden');
                    }
                    break;
            }
            updateNavButtons();
            updateFlagButton();
        }

        function selectAnswer(answer) {
            studentAnswers[currentQuestionIndex] = {
                id: quizData[currentQuestionIndex].id,
                answer: answer,
                flagged: studentAnswers[currentQuestionIndex]?.flagged || false
            };
            if (quizData[currentQuestionIndex].type !== 'fib') renderQuestion();
            updateProgressBar();
        }

        function updateNavButtons() {
            const isFirstQ = currentQuestionIndex === 0;
            const isLastQ = currentQuestionIndex === quizData.length - 1;
            document.getElementById('prev-btn').style.visibility = isFirstQ ? 'hidden' : 'visible';
            document.getElementById('next-btn').style.display = !isLastQ ? 'block' : 'none';
            document.getElementById('submit-btn').style.display = (isLastQ && !isReviewMode) ? 'block' : 'none';
            document.getElementById('back-to-results-btn').style.display = isReviewMode ? 'block' : 'none';
        }
        
        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentQuestionIndex < quizData.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });
        
        document.getElementById('submit-btn').addEventListener('click', () => {
            const unanswered = studentAnswers.filter(a => a === null || a.answer === null || a.answer === '').length;
            let message = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?";
            if (unanswered > 0) message += ` V·∫´n c√≤n ${unanswered} c√¢u ch∆∞a ƒë∆∞·ª£c tr·∫£ l·ªùi.`;
            showModalMessage(`
                <h3 class="text-xl font-bold mb-4">X√°c nh·∫≠n n·ªôp b√†i</h3>
                <p class="mb-6">${message}</p>
                <div class="flex justify-center gap-4">
                    <button onclick="closeModal()" class="secondary-button bg-slate-300 py-2 px-6 rounded-lg">H·ªßy</button>
                    <button onclick="finalizeAndSubmit()" class="secondary-button bg-gradient-to-r from-teal-500 to-cyan-600 text-white py-2 px-6 rounded-lg">N·ªôp b√†i</button>
                </div>
            `, 'confirm', false);
        });

        function finalizeAndSubmit() {
            if (activeTimer) clearInterval(activeTimer);
            studentAnswers.forEach((ans, i) => {
                if (ans) ans.timeTaken = questionTimers[i];
                else studentAnswers[i] = { id: quizData[i].id, answer: null, timeTaken: questionTimers[i], flagged: false };
            });
            submitQuizData();
        }
        
        async function submitQuizData() {
            const payload = { name: studentName, answers: studentAnswers };
            const result = await fetchFromGAS('submitQuiz', payload);
            if (result) displayResults(result);
        }

        function displayResults(result) {
            quizResultsData = result; 
            document.getElementById('quiz-container').classList.add('hidden');
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.classList.remove('hidden');
            document.getElementById('result-student-name').textContent = studentName;
            document.getElementById('correct-count').textContent = `${result.correctCount}/${result.total}`;
            document.getElementById('percentage').textContent = `${result.percentage}%`;
            document.getElementById('ai-analysis').textContent = result.analysis;
            document.getElementById('feedback-comment').textContent = result.feedbackComment;
            
            autoUploadSummary(result);

            document.getElementById('review-quiz-btn').onclick = startReviewMode;
            document.getElementById('download-summary-btn').onclick = () => downloadSummaryToLocal(result);
            
            if (result.percentage >= 80) launchConfetti();
        }
        
        function startReviewMode() {
            isReviewMode = true;
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('flag-btn').style.display = 'none';
            currentQuestionIndex = 0;
            renderQuestion();
            renderProgressBar(true);
        }

        document.getElementById('back-to-results-btn').onclick = () => {
            isReviewMode = false;
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('flag-btn').style.display = 'block';
        };

        function renderProgressBar(isReview = false) {
            const bar = document.getElementById('progress-bar');
            bar.innerHTML = '';
            quizData.forEach((q, index) => {
                const item = document.createElement('button');
                item.className = 'w-8 h-8 rounded-full border-2 flex items-center justify-center font-semibold transition-all';
                item.textContent = index + 1;
                item.onclick = () => {
                    currentQuestionIndex = index;
                    renderQuestion();
                };
                const studentAns = studentAnswers[index];
                if (isReview) {
                    const correctAnsObj = quizResultsData.correctAnswers.find(ans => ans.id === q.id);
                    let isCorrect = false;
                    if (studentAns && correctAnsObj) {
                        const ansValue = studentAns.answer;
                        const correctValue = correctAnsObj.answer;
                        isCorrect = q.type === 'fib' ? correctValue.includes((ansValue || '').toString().trim().toLowerCase()) : ansValue === correctValue;
                    }
                    item.classList.add(isCorrect ? 'bg-teal-100' : 'bg-rose-100', isCorrect ? 'border-teal-300' : 'border-rose-300');
                } else {
                    if (studentAns !== null) item.classList.add('bg-cyan-100', 'border-cyan-300');
                    else item.classList.add('bg-slate-100', 'border-slate-300');
                    if (studentAns?.flagged) item.classList.add('ring-2', 'ring-amber-400');
                }
                bar.appendChild(item);
            });
        }

        function toggleFlag() {
            if (!studentAnswers[currentQuestionIndex]) {
                 studentAnswers[currentQuestionIndex] = { id: quizData[currentQuestionIndex].id, answer: null, timeTaken: 0, flagged: false };
            }
            studentAnswers[currentQuestionIndex].flagged = !studentAnswers[currentQuestionIndex].flagged;
            updateFlagButton();
            renderProgressBar();
        }

        function updateFlagButton() {
            const flagBtn = document.getElementById('flag-btn');
            if (studentAnswers[currentQuestionIndex]?.flagged) flagBtn.classList.add('flagged');
            else flagBtn.classList.remove('flagged');
        }
        
        function updateProgressBar() {
            if (isReviewMode) return;
            const item = document.getElementById('progress-bar').children[currentQuestionIndex];
            if (studentAnswers[currentQuestionIndex] !== null) {
                 item.classList.remove('bg-slate-100', 'border-slate-300');
                 item.classList.add('bg-cyan-100', 'border-cyan-300');
            }
        }
        
        // --- SUMMARY & DOWNLOAD ---
        
        async function autoUploadSummary(result) {
            const summaryHtml = generateSummaryHtml(result);
            console.log("Attempting to auto-upload summary to Drive...");
            const response = await fetchFromGASSilent('saveSummaryToDrive', {
                name: studentName,
                topic: quizTopic,
                content: summaryHtml
            });
            if (response && response.status === 'success') {
                console.log("Auto-upload to Drive successful.");
            } else {
                console.error("Auto-upload to Drive failed silently.");
            }
        }

        function downloadSummaryToLocal(result) {
            const summaryHtml = generateSummaryHtml(result);
            const blob = new Blob([summaryHtml], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
            a.href = url;
            a.download = `${studentName} - Tom tat bai lam - ${today}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateSummaryHtml(result) {
            const theory1Html = document.getElementById('theory-section-1').innerHTML;
            const theory2Html = document.getElementById('theory-section-2').innerHTML;
            const fullTheoryHtml = `<div class="theory-section">${theory1Html}</div><div class="theory-section">${theory2Html}</div>`;
            let questionsHtml = quizData.map((q, i) => {
                const studentAns = studentAnswers[i];
                const correctAnsObj = result.correctAnswers.find(ans => ans.id === q.id);
                let isCorrect = false;
                if (studentAns && correctAnsObj) {
                    const studentAnswerText = studentAns.answer === null ? '' : studentAns.answer.toString().trim().toLowerCase();
                    isCorrect = q.type === 'fib' ? correctAnsObj.answer.includes(studentAnswerText) : studentAns.answer === correctAnsObj.answer;
                }
                let answerHtml = `<li><strong>C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n:</strong> ${studentAns.answer === null ? '<em>Ch∆∞a tr·∫£ l·ªùi</em>' : studentAns.answer}</li>`;
                if (!isCorrect) {
                    const correctAnswerText = Array.isArray(correctAnsObj.answer) ? correctAnsObj.answer.join(' ho·∫∑c ') : correctAnsObj.answer;
                    answerHtml += `<li class="correct-ans"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${correctAnswerText}</li>`;
                }
                return `<div class="question-summary ${isCorrect ? 'correct' : 'incorrect'}"><h4>C√¢u ${i + 1}: ${q.question}</h4><ul>${answerHtml}</ul></div>`;
            }).join('');

            return `<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><title>T√≥m t·∫Øt b√†i l√†m c·ªßa ${studentName}</title><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;line-height:1.6;color:#333}.container{max-width:800px;margin:auto;padding:20px;border:1px solid #ddd;border-radius:8px;background:#fff}.header{text-align:center;border-bottom:2px solid #eee;padding-bottom:10px;margin-bottom:20px}h1,h2,h3,h4{color:#2c3e50}.result-overview{background:#eaf5ff;padding:15px;border-radius:8px;text-align:center;margin-bottom:20px}.ai-analysis{background:#fffbe6;padding:15px;border-radius:8px;margin-top:20px;border:1px solid #ffecb3}.theory-section{margin-bottom:20px}.theory-section h2,.theory-section h3{border-bottom:1px solid #eee;padding-bottom:5px}.question-summary{margin-top:20px;padding:15px;border-radius:8px;border-left:5px solid}.question-summary.correct{border-left-color:#28a745;background:#e9f7ef}.question-summary.incorrect{border-left-color:#dc3545;background:#fbebed}.question-summary h4{margin-top:0}ul{padding-left:20px;list-style-type:none}li.correct-ans{color:#28a745;font-weight:bold}</style></head><body><div class="container"><div class="header"><h1>T√≥m T·∫Øt To√†n Di·ªán</h1><h2>M√¥n: H√≥a H·ªçc 9 - Ch·ªß ƒë·ªÅ: ${quizTopic}</h2><p><strong>H·ªçc sinh:</strong> ${studentName}</p></div><hr><h2>I. K·∫øt Qu·∫£ B√†i L√†m</h2><div class="result-overview"><h3>K·∫øt qu·∫£: ${result.correctCount}/${result.total} (${result.percentage}%)</h3></div><div class="ai-analysis"><h3>Nh·∫≠n x√©t t·ª´ Th·∫ßy L√¢m AI</h3><p>${result.analysis.replace(/\n/g, '<br>')}</p></div><h3>Chi ti·∫øt b√†i l√†m</h3>${questionsHtml}<hr><h2>II. T√≥m T·∫Øt L√Ω Thuy·∫øt</h2>${fullTheoryHtml}</div></body></html>`;
        }

        function showModalMessage(content, type = 'message', autoClose = true) {
            const modal = document.getElementById('modal');
            const modalContent = document.getElementById('modal-content');
            modalContent.innerHTML = content;
            modalContent.parentElement.className = 'bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center';
            if (type === 'error') modalContent.parentElement.classList.add('bg-red-100', 'border-2', 'border-red-400');
            else if (type === 'success') modalContent.parentElement.classList.add('bg-green-100', 'border-2', 'border-green-400');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if (autoClose && type !== 'loading' && type !== 'confirm') setTimeout(closeModal, 2500);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function runElectrolysisAnimation() {
            const svg = document.getElementById('electrolysis-svg');
            if (!svg || svg.dataset.animated) return;
            svg.dataset.animated = 'true';
            const ions = [];
            for (let i = 0; i < 5; i++) {
                const na = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                na.setAttribute('r', 5);
                na.setAttribute('fill', '#3b82f6');
                na.setAttribute('cx', 150 + (Math.random() - 0.5) * 80);
                na.setAttribute('cy', 110 + (Math.random() - 0.5) * 60);
                svg.appendChild(na);
                ions.push({ el: na, targetX: 90, targetY: 70 + Math.random() * 80 });
                const cl = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                cl.setAttribute('r', 5);
                cl.setAttribute('fill', '#16a34a');
                cl.setAttribute('cx', 150 + (Math.random() - 0.5) * 80);
                cl.setAttribute('cy', 110 + (Math.random() - 0.5) * 60);
                svg.appendChild(cl);
                ions.push({ el: cl, targetX: 210, targetY: 70 + Math.random() * 80 });
            }
            ions.forEach(ion => {
                const anim = document.createElementNS("http://www.w3.org/2000/svg", "animate");
                anim.setAttribute('attributeName', 'cx');
                anim.setAttribute('from', ion.el.getAttribute('cx'));
                anim.setAttribute('to', ion.targetX);
                anim.setAttribute('dur', `${2 + Math.random() * 2}s`);
                anim.setAttribute('repeatCount', 'indefinite');
                ion.el.appendChild(anim);
                const animY = document.createElementNS("http://www.w3.org/2000/svg", "animate");
                animY.setAttribute('attributeName', 'cy');
                animY.setAttribute('from', ion.el.getAttribute('cy'));
                animY.setAttribute('to', ion.targetY);
                animY.setAttribute('dur', `${2 + Math.random() * 2}s`);
                animY.setAttribute('repeatCount', 'indefinite');
                ion.el.appendChild(animY);
            });
        }
        
        function launchConfetti() {
            const container = document.getElementById('confetti-container');
            const colors = ['#06b6d4', '#22d3ee', '#f59e0b', '#facc15', '#10b981'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'absolute';
                confetti.style.width = `${Math.random() * 10 + 5}px`;
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.top = '-10%';
                confetti.style.opacity = '1';
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                container.appendChild(confetti);
                confetti.animate([
                    { top: '-10%', opacity: 1 },
                    { top: '110%', opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 3000,
                    easing: 'linear',
                    delay: Math.random() * 2000
                }).onfinish = () => confetti.remove();
            }
        }
    </script>
</body>
</html>
